<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Guided Case-Based Reasoning Trainer</title>

  <style>
    body{
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background:#f6f6f6; color:#111;
      margin:0; padding:24px 14px;
    }
    .wrap{ max-width: 920px; margin:0 auto; }
    h1{ margin:0 0 6px; font-size:26px; }
    .sub{ color:#444; margin-bottom:14px; }

    .card{
      background:#fff; border:1px solid rgba(0,0,0,.06);
      border-radius:14px; padding:16px;
      box-shadow:0 1px 10px rgba(0,0,0,.05);
      margin-top:12px;
    }

    label{ font-size:13px; font-weight:600; display:block; margin-bottom:6px; }
    textarea,input{
      width:100%; padding:11px 12px; font-size:15px;
      border-radius:10px; border:1px solid rgba(0,0,0,.18);
    }
    textarea{ min-height:120px; resize:vertical; }

    button{
      padding:11px 14px; font-size:15px;
      border-radius:10px; border:1px solid #000;
      background:#000; color:#fff; cursor:pointer;
    }
    button.secondary{
      background:#fff; color:#000;
      border-color:rgba(0,0,0,.25);
    }
    button:disabled{ opacity:.6; cursor:not-allowed; }

    .btnrow{ display:flex; gap:10px; flex-wrap:wrap; margin-top:10px; }

    .stepHeader{
      display:flex; justify-content:space-between;
      align-items:center; margin-bottom:6px;
    }
    .pill{
      font-size:12px; background:rgba(0,0,0,.05);
      padding:6px 10px; border-radius:999px;
    }

    .toggleGrid{
      display:flex; flex-wrap:wrap; gap:10px;
      margin-top:10px;
    }
    .toggle{
      padding:10px 14px; font-size:14px;
      border-radius:999px; border:1px solid rgba(0,0,0,.25);
      background:#fff; cursor:pointer;
    }
    .toggle.active{
      background:#000; color:#fff; border-color:#000;
    }
    .toggle.disabled{
      opacity:.45; cursor:not-allowed;
    }

    .small{ font-size:12px; color:#666; margin-top:6px; }
    .ok{ color:#0a7a2f; }
    .warn{ color:#b00020; }

    footer{ margin-top:18px; font-size:12px; color:#777; }
  </style>
</head>

<body>
<div class="wrap">

  <h1>Guided Case-Based Reasoning Trainer</h1>
  <p class="sub">
    Generate a case → reason through diagnosis, differentials, assessment and intervention (NPE-style).
  </p>

  <!-- CASE GENERATION -->
  <div class="card">
    <button id="generateBtn" onclick="alert('Button clicked')">
  Generate case
</button>
    <div id="status" class="small"></div>

    <label style="margin-top:10px;">Generated case vignette</label>
    <textarea id="caseText" readonly></textarea>

    <div class="btnrow">
      <button class="secondary" id="resetBtn">Reset steps</button>
      <button class="secondary" id="saveBtn">Save</button>
      <button class="secondary" id="loadBtn">Load</button>
      <button class="secondary" id="exportBtn">Export</button>
    </div>
  </div>

  <!-- STEP 1–5 -->
  <div class="card"><label>Step 1 — Presenting issue</label><textarea id="step1"></textarea></div>
  <div class="card"><label>Step 2 — Maintaining factors</label><textarea id="step2"></textarea></div>
  <div class="card"><label>Step 3 — Provisional diagnosis</label><textarea id="step3"></textarea></div>
  <div class="card"><label>Step 4 — Differential diagnoses</label><textarea id="step4"></textarea></div>
  <div class="card"><label>Step 5 — Assessments</label><textarea id="step5"></textarea></div>

  <!-- STEP 6 -->
  <div class="card">
    <div class="stepHeader">
      <strong>Step 6 — Primary modality</strong>
      <span class="pill">Choose ONE</span>
    </div>
    <div id="modalityGrid" class="toggleGrid"></div>
    <div class="small">Selected: <span id="modalityLabel">—</span></div>
  </div>

  <!-- STEP 7 -->
  <div class="card">
    <div class="stepHeader">
      <strong>Step 7 — Intervention strategies</strong>
      <span class="pill">Choose 1–4</span>
    </div>
    <div id="strategyGrid" class="toggleGrid"></div>
    <div class="small">Selected: <span id="strategyCount">0</span> / 4</div>
  </div>

  <footer>
    Educational use only. This tool supports exam reasoning, not clinical decision-making.
  </footer>
</div>

<script>
  $("generateBtn").onclick = async () => {
    $("status").textContent = "Generating case…";

    try {
      const r = await fetch("/.netlify/functions/generate-case", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({}) // no disorder passed
      });

      const raw = await r.text(); // read as text first so we can show errors

      if (!r.ok) {
        $("status").textContent = `Function error (${r.status}). See alert.`;
        alert(raw);
        return;
      }

      let data;
      try {
        data = JSON.parse(raw);
      } catch (e) {
        $("status").textContent = "Function returned non-JSON. See alert.";
        alert(raw);
        return;
      }

      const title = data?.case?.title || "Generated Case";
      const vignette = data?.case?.vignette || "";

      if (!vignette) {
        $("status").textContent = "No vignette returned. See alert.";
        alert(raw);
        return;
      }

      $("caseText").value = `${title}\n\n${vignette}`.trim();

      ["step1","step2","step3","step4","step5"].forEach(id => $(id).value = "");
      selectedModality = "";
      selectedStrategies = [];
      renderModalities();
      renderStrategies();

      $("status").textContent = "Case generated.";
    } catch (e) {
      $("status").textContent = "Network/JS error. See alert.";
      alert(e?.message || String(e));
    }
  };
</script>


</body>
</html>
