<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Guided Case-Based Reasoning Trainer</title>
  <style>
    :root { color-scheme: light; }
    body{
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background:#f6f6f6; color:#111; margin:0; padding:24px 14px;
    }
    .wrap{ max-width: 920px; margin:0 auto; }
    header{ margin-bottom: 14px; }
    h1{ margin:0 0 6px; font-size: 26px; letter-spacing:-0.02em; }
    .sub{ margin:0; color:#444; line-height:1.45; }

    .card{
      background:#fff; border:1px solid rgba(0,0,0,.06);
      border-radius:14px; padding:16px; box-shadow:0 1px 10px rgba(0,0,0,.05);
      margin-top:12px;
    }
    .row{ display:grid; grid-template-columns: 1fr; gap:12px; }
    @media (min-width: 860px){
      .row.cols2{ grid-template-columns: 1fr 1fr; }
      .row.cols3{ grid-template-columns: 1fr 1fr 1fr; }
    }

    label{ display:block; font-size:13px; color:#333; margin-bottom:6px; font-weight:600; }
    textarea, input, select{
      width:100%; box-sizing:border-box;
      padding:11px 12px; border-radius:10px; border:1px solid rgba(0,0,0,.18);
      font-size:15px; outline:none; background:#fff;
    }
    textarea{ min-height: 110px; resize: vertical; line-height:1.45; }
    textarea:focus, input:focus, select:focus{ border-color: rgba(0,0,0,.45); }

    .btnrow{ display:flex; gap:10px; flex-wrap:wrap; margin-top:10px; }
    button{
      padding:11px 13px; border-radius:10px; border:1px solid #000;
      background:#000; color:#fff; cursor:pointer; font-size:15px;
    }
    button.secondary{ background:#fff; color:#000; border-color: rgba(0,0,0,.25); }
    button:disabled{ opacity:.6; cursor:not-allowed; }

    .stepHeader{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      margin-bottom: 8px;
    }
    .stepTitle{ font-size:15px; font-weight:700; margin:0; }
    .pill{
      font-size:12px; color:#444; background: rgba(0,0,0,.05);
      padding:6px 10px; border-radius: 999px;
    }

    details{ border-top: 1px solid rgba(0,0,0,.08); padding-top: 12px; margin-top: 12px; }
    details > summary{
      cursor:pointer; font-weight:700; color:#111; list-style:none;
    }
    details > summary::-webkit-details-marker{ display:none; }

    .hint{ color:#555; font-size:13px; line-height:1.45; margin:8px 0 0; }
    .small{ font-size:12px; color:#666; margin-top:8px; }
    .ok{ color:#0a7a2f; }
    .warn{ color:#b00020; }

    .tabs{ display:flex; gap:8px; flex-wrap:wrap; margin-top: 8px; }
    .tab{
      border:1px solid rgba(0,0,0,.18); background:#fff; color:#111;
      padding:8px 10px; border-radius:999px; cursor:pointer; font-size:13px;
    }
    .tab.active{ border-color:#000; background:#000; color:#fff; }

    .scorebox{
      display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top: 10px;
    }
    .score{
      background: rgba(0,0,0,.03); border:1px solid rgba(0,0,0,.08);
      border-radius:12px; padding:10px 12px;
    }
    .score strong{ display:block; font-size:13px; color:#444; }
    .score span{ font-size:18px; font-weight:800; }

    footer{ margin-top:16px; color:#777; font-size:12px; line-height:1.4; }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Guided Case-Based Reasoning Trainer</h1>
      <p class="sub">
        Train the NPE-style thinking loop: <strong>Presenting problem → symptoms → assessments → diagnosis → differentials → intervention</strong>.
      </p>
    </header>

    <!-- CASE INPUT -->
    <div class="card">
      <div class="row cols2">
        <div>
          <label for="mode">Mode</label>
          <select id="mode">
            <option value="manual" selected>Manual (paste a case vignette)</option>
            <option value="ai">AI (call Netlify function to generate a case)</option>
          </select>
          <p class="small">AI mode is optional. Manual mode works immediately.</p>
        </div>

        <div>
          <label for="disorder">DSM-5 Disorder (optional)</label>
          <select id="disorder">
            <option value="">— Choose (optional) —</option>
            <option>Generalised Anxiety Disorder</option>
            <option>Social Anxiety Disorder</option>
            <option>Major Depressive Disorder</option>
            <option>Panic Disorder</option>
            <option>Obsessive-Compulsive Disorder</option>
            <option>Posttraumatic Stress Disorder</option>
            <option>Specific Phobia</option>
            <option>ADHD</option>
          </select>
          <p class="small">Used for AI generation (if enabled), or just to label your session.</p>
        </div>
      </div>

      <div class="row">
        <div>
          <label for="caseText">Case vignette / presenting problem</label>
          <textarea id="caseText" placeholder="Paste a case vignette here. Treat the presenting problem as the 'exam question' and work through the steps below."></textarea>
        </div>
      </div>

      <div class="btnrow">
        <button id="generateBtn">Generate case</button>
        <button class="secondary" id="loadExampleBtn">Load example case</button>
        <button class="secondary" id="resetBtn">Reset all steps</button>
        <button class="secondary" id="saveBtn">Save draft</button>
        <button class="secondary" id="loadBtn">Load saved</button>
      </div>

      <div id="status" class="small"></div>
    </div>

    <!-- GUIDED STEPS -->
    <div class="card">
      <div class="stepHeader">
        <p class="stepTitle">Step 1 — Extract symptoms from the presenting problem</p>
        <span class="pill">Focus on key features</span>
      </div>
      <textarea id="stepSymptoms" placeholder="List key symptoms / clinical features (bullet points). What matters? What’s noise?"></textarea>

      <details>
        <summary>Hint prompts</summary>
        <p class="hint">
          • What is the main complaint?<br/>
          • Timeframe (weeks/months)?<br/>
          • Triggers/context (social, work, health, trauma)?<br/>
          • Avoidance/safety behaviours?<br/>
          • Functional impairment?<br/>
          • Risk flags (self-harm, harm to others, psychosis, intoxication)?<br/>
          • Medical contributors to rule out?
        </p>
      </details>
    </div>

    <div class="card">
      <div class="stepHeader">
        <p class="stepTitle">Step 2 — Match symptoms to assessments</p>
        <span class="pill">Evidence-based tools</span>
      </div>
      <textarea id="stepAssess" placeholder="For each symptom cluster, what psychometrics or structured tools would you use? (e.g., PHQ-9, GAD-7, K6/K10, PCL-5, LSAS, ASRS, SCID modules, risk screens, etc.)"></textarea>

      <details>
        <summary>Hint prompts</summary>
        <p class="hint">
          • What screening tool fits best (quick, validated)?<br/>
          • What confirms severity / tracks change?<br/>
          • What differentiates similar diagnoses?<br/>
          • What is practical in the setting (time, access)?
        </p>
      </details>
    </div>

    <div class="card">
      <div class="stepHeader">
        <p class="stepTitle">Step 3 — Diagnostic reasoning + provisional diagnosis</p>
        <span class="pill">Tie back to evidence</span>
      </div>
      <textarea id="stepDx" placeholder="Provisional diagnosis and the reasoning: which features support it? timeframe? impairment?"></textarea>

      <details>
        <summary>Hint prompts</summary>
        <p class="hint">
          • Which DSM-5 criteria are met (briefly)?<br/>
          • Which features are the strongest discriminators?<br/>
          • What would you need to ask to confirm?
        </p>
      </details>
    </div>

    <div class="card">
      <div class="stepHeader">
        <p class="stepTitle">Step 4 — Differentials (rule out and justify)</p>
        <span class="pill">Practice inhibition of distractors</span>
      </div>
      <textarea id="stepDiff" placeholder="List likely differentials and explicitly rule them out: why they don’t fit this presentation."></textarea>

      <details>
        <summary>Hint prompts</summary>
        <p class="hint">
          • What is the “closest competitor” diagnosis?<br/>
          • What missing criterion rules it out?<br/>
          • What alternative explanation (substance/medical/adjustment)?<br/>
          • What comorbidities might coexist?
        </p>
      </details>
    </div>

    <div class="card">
      <div class="stepHeader">
        <p class="stepTitle">Step 5 — Intervention planning</p>
        <span class="pill">Link dx → modality → targets</span>
      </div>
      <textarea id="stepTx" placeholder="Choose a primary modality (CBT/ACT/DBT/family/etc.) and list 3–6 targets/interventions aligned with the formulation."></textarea>

      <details>
        <summary>Hint prompts</summary>
        <p class="hint">
          • What’s first-line for this problem?<br/>
          • What are 3 practical interventions you’d start with?<br/>
          • What would you monitor (outcomes/measures)?<br/>
          • Any contraindications or safety considerations?
        </p>
      </details>
    </div>

    <!-- QUICK SELF-CHECK -->
    <div class="card">
      <div class="stepHeader">
        <p class="stepTitle">Quick self-check</p>
        <span class="pill">Speed + clarity</span>
      </div>

      <div class="row cols3">
        <div>
          <label for="timeTaken">Time taken (minutes)</label>
          <input id="timeTaken" type="number" min="0" step="1" placeholder="e.g. 12" />
        </div>
        <div>
          <label for="confidence">Confidence (0–10)</label>
          <input id="confidence" type="number" min="0" max="10" step="1" placeholder="e.g. 7" />
        </div>
        <div>
          <label for="clarity">Clarity of reasoning (0–10)</label>
          <input id="clarity" type="number" min="0" max="10" step="1" placeholder="e.g. 8" />
        </div>
      </div>

      <div class="btnrow">
        <button class="secondary" id="exportBtn">Export as text</button>
      </div>

      <div class="scorebox" aria-live="polite">
        <div class="score"><strong>Completion</strong><span id="completionPct">0%</span></div>
        <div class="score"><strong>Saved locally</strong><span id="savedFlag">No</span></div>
      </div>
    </div>

    <footer>
      Educational use only. Always follow AHPRA/NPE guidance and your course materials. This tool is a reasoning practice scaffold, not clinical advice.
    </footer>
  </div>

  <script>
    // ---------- Helpers ----------
    const $ = (id) => document.getElementById(id);
    const LS_KEY = "case_reasoning_trainer_v1";

    const fields = [
      "caseText","disorder","mode",
      "stepSymptoms","stepAssess","stepDx","stepDiff","stepTx",
      "timeTaken","confidence","clarity"
    ];

    function getState() {
      const s = {};
      for (const f of fields) s[f] = $(f).value ?? "";
      return s;
    }

    function setState(s) {
      for (const f of fields) if (f in s) $(f).value = s[f] ?? "";
      updateCompletion();
      setSavedFlag(false);
    }

    function setStatus(msg, kind="") {
      const el = $("status");
      el.textContent = msg || "";
      el.className = "small " + (kind || "");
    }

    function updateCompletion() {
      const stepIds = ["stepSymptoms","stepAssess","stepDx","stepDiff","stepTx"];
      const filled = stepIds.filter(id => ($(id).value || "").trim().length > 0).length;
      const pct = Math.round((filled / stepIds.length) * 100);
      $("completionPct").textContent = pct + "%";
    }

    function setSavedFlag(saved) {
      $("savedFlag").textContent = saved ? "Yes" : "No";
      $("savedFlag").className = saved ? "ok" : "";
    }

    // ---------- Button actions ----------
    $("resetBtn").addEventListener("click", () => {
      if (!confirm("Reset all steps and clear the case text?")) return;
      setState({
        caseText: "",
        stepSymptoms: "",
        stepAssess: "",
        stepDx: "",
        stepDiff: "",
        stepTx: "",
        timeTaken: "",
        confidence: "",
        clarity: ""
      });
      setStatus("Reset complete.");
    });

    $("saveBtn").addEventListener("click", () => {
      localStorage.setItem(LS_KEY, JSON.stringify(getState()));
      setSavedFlag(true);
      setStatus("Saved locally (in this browser).", "ok");
    });

    $("loadBtn").addEventListener("click", () => {
      const raw = localStorage.getItem(LS_KEY);
      if (!raw) { setStatus("No saved draft found.", "warn"); return; }
      try {
        const s = JSON.parse(raw);
        setState(s);
        setSavedFlag(true);
        setStatus("Loaded saved draft.", "ok");
      } catch {
        setStatus("Could not load saved draft (corrupt data).", "warn");
      }
    });

    $("exportBtn").addEventListener("click", async () => {
      const s = getState();
      const out =
`CASE REASONING EXPORT
Disorder label: ${s.disorder || "(not set)"}

CASE VIGNETTE
${s.caseText}

STEP 1 — SYMPTOMS
${s.stepSymptoms}

STEP 2 — ASSESSMENTS
${s.stepAssess}

STEP 3 — DIAGNOSIS
${s.stepDx}

STEP 4 — DIFFERENTIALS
${s.stepDiff}

STEP 5 — INTERVENTION
${s.stepTx}

SELF-CHECK
Time (min): ${s.timeTaken || ""}
Confidence (0–10): ${s.confidence || ""}
Clarity (0–10): ${s.clarity || ""}
`;
      await navigator.clipboard.writeText(out);
      setStatus("Export copied to clipboard.", "ok");
    });

    $("loadExampleBtn").addEventListener("click", () => {
      setState({
        disorder: "Social Anxiety Disorder",
        caseText:
`A 27-year-old accountant reports intense anxiety during staff meetings and presentations. She experiences racing heart, trembling, and shortness of breath. She fears she will say something “stupid” and be judged. She worries for days beforehand and avoids situations where she might be the centre of attention. She notes growing low mood due to avoidance and reduced social contact. Symptoms have been present for five months and are impacting work performance.`,
      });
      setStatus("Example case loaded. Work through the steps below.");
    });

    // ---------- AI generation (optional) ----------
    $("generateBtn").addEventListener("click", async () => {
      const mode = $("mode").value;

      // Manual mode: no API call—just a nudge
      if (mode === "manual") {
        if (!($("caseText").value || "").trim()) {
          setStatus("Paste a case vignette first (or click “Load example case”).", "warn");
        } else {
          setStatus("Great — now start Step 1: extract symptoms.", "ok");
        }
        return;
      }

      // AI mode: call your Netlify function
      const disorder = $("disorder").value || "Generalised Anxiety Disorder";
      $("generateBtn").disabled = true;
      setStatus("Generating case via Netlify function…");

      try {
        const res = await fetch("/.netlify/functions/generate-case", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ disorder })
        });

        const text = await res.text();
        if (!res.ok) {
          setStatus(`Request failed (${res.status}).`, "warn");
          alert(text);
          return;
        }

        let data;
        try { data = JSON.parse(text); }
        catch {
          setStatus("Function returned non-JSON. Check your function output.", "warn");
          alert(text);
          return;
        }

        // Minimal expected keys
        const vignette = data.vignette || data.case || "";
        const title = data.title || `Case: ${disorder}`;

        $("caseText").value = `${title}\n\n${vignette}`.trim();
        // clear reasoning steps for a fresh run
        $("stepSymptoms").value = "";
        $("stepAssess").value = "";
        $("stepDx").value = "";
        $("stepDiff").value = "";
        $("stepTx").value = "";

        updateCompletion();
        setSavedFlag(false);
        setStatus("Case generated. Start Step 1: extract symptoms.", "ok");
      } catch (e) {
        setStatus("Failed to reach the function. Make sure you’re on the Netlify URL.", "warn");
        alert(e?.message || String(e));
      } finally {
        $("generateBtn").disabled = false;
      }
    });

    // ---------- Live completion tracking ----------
    ["stepSymptoms","stepAssess","stepDx","stepDiff","stepTx"].forEach(id => {
      $(id).addEventListener("input", updateCompletion);
    });

    // Initial
    updateCompletion();
  </script>
</body>
</html>
