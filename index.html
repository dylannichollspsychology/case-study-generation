<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>NPE Guided Case-Based Reasoning</title>
  <style>
    :root { color-scheme: light; }
    body{
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background:#f6f6f6; color:#111; margin:0; padding:24px 14px;
    }
    .wrap{ max-width: 980px; margin:0 auto; }
    header{ margin-bottom: 14px; }
    h1{ margin:0 0 6px; font-size: 26px; letter-spacing:-0.02em; }
    .sub{ margin:0; color:#444; line-height:1.45; }

    .card{
      background:#fff; border:1px solid rgba(0,0,0,.06);
      border-radius:14px; padding:16px; box-shadow:0 1px 10px rgba(0,0,0,.05);
      margin-top:12px;
    }

    .row{ display:grid; grid-template-columns: 1fr; gap:12px; }
    @media (min-width: 920px){
      .row.cols2{ grid-template-columns: 1fr 1fr; }
      .row.cols3{ grid-template-columns: 1fr 1fr 1fr; }
    }

    label{ display:block; font-size:13px; color:#333; margin-bottom:6px; font-weight:600; }
    textarea, input, select{
      width:100%; box-sizing:border-box;
      padding:11px 12px; border-radius:10px; border:1px solid rgba(0,0,0,.18);
      font-size:15px; outline:none; background:#fff;
    }
    textarea{ min-height: 110px; resize: vertical; line-height:1.45; }
    textarea:focus, input:focus, select:focus{ border-color: rgba(0,0,0,.45); }

    .btnrow{ display:flex; gap:10px; flex-wrap:wrap; margin-top:10px; }
    button{
      padding:11px 13px; border-radius:10px; border:1px solid #000;
      background:#000; color:#fff; cursor:pointer; font-size:15px;
    }
    button.secondary{ background:#fff; color:#000; border-color: rgba(0,0,0,.25); }
    button:disabled{ opacity:.6; cursor:not-allowed; }

    .stepHeader{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      margin-bottom: 8px;
    }
    .stepTitle{ font-size:15px; font-weight:750; margin:0; }
    .pill{
      font-size:12px; color:#444; background: rgba(0,0,0,.05);
      padding:6px 10px; border-radius: 999px;
    }

    details{ border-top: 1px solid rgba(0,0,0,.08); padding-top: 12px; margin-top: 12px; }
    details > summary{
      cursor:pointer; font-weight:700; color:#111; list-style:none;
    }
    details > summary::-webkit-details-marker{ display:none; }

    .hint{ color:#555; font-size:13px; line-height:1.45; margin:8px 0 0; }
    .small{ font-size:12px; color:#666; margin-top:8px; }
    .ok{ color:#0a7a2f; }
    .warn{ color:#b00020; }

    .toggleGrid{
      display:flex; flex-wrap:wrap; gap:10px; margin-top:10px;
    }
    .toggle{
      border:1px solid rgba(0,0,0,.18);
      background:#fff; color:#111;
      border-radius:999px; padding:10px 12px;
      font-size:14px; cursor:pointer;
      user-select:none;
      transition: transform .04s ease;
    }
    .toggle:active{ transform: scale(0.98); }
    .toggle[aria-pressed="true"]{
      background:#000; color:#fff; border-color:#000;
    }
    .toggle.disabled{
      opacity:.45; cursor:not-allowed;
    }

    .meta{
      display:flex; gap:10px; flex-wrap:wrap; align-items:center;
      margin-top:10px; color:#444; font-size:13px;
    }
    .badge{
      background: rgba(0,0,0,.05);
      border:1px solid rgba(0,0,0,.08);
      border-radius:999px;
      padding:6px 10px;
    }

    .scorebox{
      display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top: 10px;
    }
    .score{
      background: rgba(0,0,0,.03); border:1px solid rgba(0,0,0,.08);
      border-radius:12px; padding:10px 12px;
    }
    .score strong{ display:block; font-size:13px; color:#444; }
    .score span{ font-size:18px; font-weight:850; }

    footer{ margin-top:16px; color:#777; font-size:12px; line-height:1.4; }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>NPE Guided Case-Based Reasoning</h1>
      <p class="sub">
        Work through a case like an exam stem: <strong>presenting issue → maintaining factors → diagnosis → differentials → assessments → modality → strategies</strong>.
      </p>
    </header>

    <!-- CASE INPUT -->
    <div class="card">
      <div class="row cols2">
        <div>
          <label for="mode">Mode</label>
          <select id="mode">
            <option value="manual" selected>Manual (paste a case vignette)</option>
            <option value="ai">AI (generate a vignette via Netlify function)</option>
          </select>
          <p class="small">Manual mode works immediately. AI mode calls <code>/.netlify/functions/generate-case</code>.</p>
        </div>

        <div>
          <label for="disorder">DSM-5 disorder (optional label / for AI generation)</label>
          <select id="disorder">
            <option value="">— Choose (optional) —</option>
            <option>Generalised Anxiety Disorder</option>
            <option>Social Anxiety Disorder</option>
            <option>Major Depressive Disorder</option>
            <option>Panic Disorder</option>
            <option>Obsessive-Compulsive Disorder</option>
            <option>Posttraumatic Stress Disorder</option>
            <option>Specific Phobia</option>
            <option>ADHD</option>
          </select>
        </div>
      </div>

      <div class="row">
        <div>
          <label for="caseText">Case vignette / presenting problem</label>
          <textarea id="caseText" placeholder="Paste a case vignette here, or switch to AI mode and generate one."></textarea>
        </div>
      </div>

      <div class="btnrow">
        <button id="generateBtn">Generate case</button>
        <button class="secondary" id="loadExampleBtn">Load example case</button>
        <button class="secondary" id="resetBtn">Reset all steps</button>
        <button class="secondary" id="saveBtn">Save draft</button>
        <button class="secondary" id="loadBtn">Load saved</button>
        <button class="secondary" id="exportBtn">Export as text</button>
      </div>

      <div id="status" class="small"></div>
    </div>

    <!-- STEP 1 -->
    <div class="card">
      <div class="stepHeader">
        <p class="stepTitle">Step 1 — Presenting issue</p>
        <span class="pill">1–2 sentences · timeframe + impairment</span>
      </div>
      <textarea id="step1" placeholder="Summarise the presenting issue in 1–2 sentences. Include timeframe + level of impairment."></textarea>
      <details>
        <summary>Hint prompts</summary>
        <p class="hint">
          • What is the primary complaint?<br/>
          • How long has it been going on?<br/>
          • What domains are impaired (work, social, study, relationships)?<br/>
          • Any immediate risks or red flags to note (briefly)?
        </p>
      </details>
    </div>

    <!-- STEP 2 -->
    <div class="card">
      <div class="stepHeader">
        <p class="stepTitle">Step 2 — Maintaining factors</p>
        <span class="pill">mechanisms, not labels</span>
      </div>
      <textarea id="step2" placeholder="What is maintaining the problem? (e.g., avoidance behaviours, reinforcement, rumination, negative thoughts, safety behaviours, sleep disruption, etc.)"></textarea>
      <details>
        <summary>Hint prompts</summary>
        <p class="hint">
          • What does the client do that reduces distress short-term but worsens it long-term?<br/>
          • What triggers and consequences keep the cycle going?<br/>
          • Any patterns of avoidance, reassurance seeking, checking, withdrawal?<br/>
          • Any thinking patterns (catastrophising, threat monitoring, self-criticism)?
        </p>
      </details>
    </div>

    <!-- STEP 3 -->
    <div class="card">
      <div class="stepHeader">
        <p class="stepTitle">Step 3 — Provisional diagnosis</p>
        <span class="pill">best fit</span>
      </div>
      <textarea id="step3" placeholder="State the provisional diagnosis and the main reasons it fits (briefly)."></textarea>
      <details>
        <summary>Hint prompts</summary>
        <p class="hint">
          • Which features are most diagnostic?<br/>
          • Timeframe threshold met?<br/>
          • Impairment present?<br/>
          • What key question would confirm it?
        </p>
      </details>
    </div>

    <!-- STEP 4 -->
    <div class="card">
      <div class="stepHeader">
        <p class="stepTitle">Step 4 — Differential diagnoses</p>
        <span class="pill">rule out + justify</span>
      </div>
      <textarea id="step4" placeholder="List key differential diagnoses and briefly justify why each is less likely / ruled out."></textarea>
      <details>
        <summary>Hint prompts</summary>
        <p class="hint">
          • What is the closest competing diagnosis?<br/>
          • Which criterion is missing for the differential?<br/>
          • Any substance/medical/adjustment explanations to consider?
        </p>
      </details>
    </div>

    <!-- STEP 5 -->
    <div class="card">
      <div class="stepHeader">
        <p class="stepTitle">Step 5 — Assessments</p>
        <span class="pill">screening + clarification</span>
      </div>
      <textarea id="step5" placeholder="What assessments would help with screening and diagnostic clarification? (Include 2–5 specific tools if relevant.)"></textarea>
      <details>
        <summary>Hint prompts</summary>
        <p class="hint">
          • What brief screening fits the presenting problem?<br/>
          • What tool clarifies diagnosis / severity?<br/>
          • What baseline measure would you track over time?<br/>
          • Any risk screen if indicated?
        </p>
      </details>
    </div>

    <!-- STEP 6 -->
    <div class="card">
      <div class="stepHeader">
        <p class="stepTitle">Step 6 — Primary modality</p>
        <span class="pill">choose ONE</span>
      </div>

      <div class="toggleGrid" id="modalityGrid" aria-label="Primary modality options"></div>
      <div class="meta">
        <span class="badge" id="modalityChosen">Chosen: —</span>
      </div>
    </div>

    <!-- STEP 7 -->
    <div class="card">
      <div class="stepHeader">
        <p class="stepTitle">Step 7 — Intervention strategies</p>
        <span class="pill">choose 1–4</span>
      </div>

      <div class="toggleGrid" id="strategyGrid" aria-label="Intervention strategy options"></div>
      <div class="meta">
        <span class="badge" id="strategyCount">Selected: 0 / 4</span>
        <span class="small">Suggestion: choose <strong>1–4</strong> strategies that logically follow from your chosen modality.</span>
      </div>
    </div>

    <!-- Self-check + progress -->
    <div class="card">
      <div class="stepHeader">
        <p class="stepTitle">Quick self-check</p>
        <span class="pill">speed + clarity</span>
      </div>

      <div class="row cols3">
        <div>
          <label for="timeTaken">Time taken (minutes)</label>
          <input id="timeTaken" type="number" min="0" step="1" placeholder="e.g. 12" />
        </div>
        <div>
          <label for="confidence">Confidence (0–10)</label>
          <input id="confidence" type="number" min="0" max="10" step="1" placeholder="e.g. 7" />
        </div>
        <div>
          <label for="clarity">Clarity (0–10)</label>
          <input id="clarity" type="number" min="0" max="10" step="1" placeholder="e.g. 8" />
        </div>
      </div>

      <div class="scorebox" aria-live="polite">
        <div class="score"><strong>Completion</strong><span id="completionPct">0%</span></div>
        <div class="score"><strong>Saved locally</strong><span id="savedFlag">No</span></div>
      </div>
    </div>

    <footer>
      Educational use only. This scaffold supports clinical reasoning practice for the NPE; it is not clinical advice.
    </footer>
  </div>

  <script>
    // ---------- Config ----------
    const LS_KEY = "npe_case_reasoning_v2";

    const modalities = [
      "Cognitive Behavioural Therapy",
      "Interpersonal Therapy",
      "Family Therapy",
      "Psychodynamic Therapy",
      "Narrative Therapy",
      "Solution-Focused Therapy",
      "Motivational Interviewing"
    ];

    const strategies = [
      "Psychoeducation",
      "Interpersonal therapy techniques",
      "Psychodynamic therapy techniques",
      "Solution-focused techniques",
      "Narrative therapy techniques",
      "Behaviour modification",
      "Gradual exposure",
      "Exposure response prevention",
      "Interoceptive exposure",
      "Prolonged exposure",
      "Cognitive restructuring",
      "Acceptance strategies",
      "Self-management",
      "Relapse prevention",
      "Progressive muscle relaxation",
      "Breathing retraining",
      "Problem solving skills training",
      "Anger management",
      "Social skills training",
      "Assertiveness skills training",
      "Stress management",
      "Mindfulness skills",
      "Parenting skills"
    ];

    // ---------- Helpers ----------
    const $ = (id) => document.getElementById(id);

    function setStatus(msg, kind="") {
      const el = $("status");
      el.textContent = msg || "";
      el.className = "small " + (kind || "");
    }

    function setSavedFlag(saved) {
      $("savedFlag").textContent = saved ? "Yes" : "No";
      $("savedFlag").className = saved ? "ok" : "";
    }

    function updateCompletion() {
      // Steps 1–5 are text; step 6 is single selection; step 7 requires at least 1 strategy
      const textSteps = ["step1","step2","step3","step4","step5"];
      const filledText = textSteps.filter(id => (($(id).value||"").trim().length > 0)).length;

      const modalityDone = selectedModality ? 1 : 0;
      const strategyDone = selectedStrategies.length > 0 ? 1 : 0;

      const total = textSteps.length + 2; // + modality + strategies
      const done = filledText + modalityDone + strategyDone;
      const pct = Math.round((done / total) * 100);

      $("completionPct").textContent = pct + "%";
    }

    function getState() {
      return {
        mode: $("mode").value,
        disorder: $("disorder").value,
        caseText: $("caseText").value,
        step1: $("step1").value,
        step2: $("step2").value,
        step3: $("step3").value,
        step4: $("step4").value,
        step5: $("step5").value,
        selectedModality,
        selectedStrategies,
        timeTaken: $("timeTaken").value,
        confidence: $("confidence").value,
        clarity: $("clarity").value
      };
    }

    function setState(s) {
      $("mode").value = s.mode || "manual";
      $("disorder").value = s.disorder || "";
      $("caseText").value = s.caseText || "";

      $("step1").value = s.step1 || "";
      $("step2").value = s.step2 || "";
      $("step3").value = s.step3 || "";
      $("step4").value = s.step4 || "";
      $("step5").value = s.step5 || "";

      $("timeTaken").value = s.timeTaken || "";
      $("confidence").value = s.confidence || "";
      $("clarity").value = s.clarity || "";

      // selections
      selectedModality = s.selectedModality || "";
      selectedStrategies = Array.isArray(s.selectedStrategies) ? s.selectedStrategies.slice(0,4) : [];

      renderModalityButtons();
      renderStrategyButtons();

      updateCompletion();
      setSavedFlag(true);
      setStatus("Loaded saved draft.", "ok");
    }

    function exportText() {
      const s = getState();
      const stratLine = (s.selectedStrategies && s.selectedStrategies.length)
        ? s.selectedStrategies.map(x => `- ${x}`).join("\n")
        : "(none selected)";

      return `NPE CASE-BASED REASONING EXPORT

DSM-5 Disorder label: ${s.disorder || "(not set)"}

CASE VIGNETTE
${s.caseText || "(empty)"}

STEP 1 — PRESENTING ISSUE (timeframe + impairment)
${s.step1 || ""}

STEP 2 — MAINTAINING FACTORS
${s.step2 || ""}

STEP 3 — PROVISIONAL DIAGNOSIS
${s.step3 || ""}

STEP 4 — DIFFERENTIAL DIAGNOSES
${s.step4 || ""}

STEP 5 — ASSESSMENTS (screening + clarification)
${s.step5 || ""}

STEP 6 — PRIMARY MODALITY (ONE)
${s.selectedModality || "(none selected)"}

STEP 7 — INTERVENTION STRATEGIES (1–4)
${stratLine}

SELF-CHECK
Time (min): ${s.timeTaken || ""}
Confidence (0–10): ${s.confidence || ""}
Clarity (0–10): ${s.clarity || ""}
`;
    }

    // ---------- Step 6 (single select) ----------
    let selectedModality = "";

    function renderModalityButtons() {
      const grid = $("modalityGrid");
      grid.innerHTML = "";

      modalities.forEach(name => {
        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = "toggle";
        btn.textContent = name;
        btn.setAttribute("aria-pressed", selectedModality === name ? "true" : "false");

        btn.addEventListener("click", () => {
          selectedModality = (selectedModality === name) ? "" : name; // allow deselect if clicked again
          renderModalityButtons();
          updateCompletion();
          setSavedFlag(false);
        });

        grid.appendChild(btn);
      });

      $("modalityChosen").textContent = "Chosen: " + (selectedModality || "—");
    }

    // ---------- Step 7 (multi select, max 4) ----------
    let selectedStrategies = [];

    function renderStrategyButtons() {
      const grid = $("strategyGrid");
      grid.innerHTML = "";

      const atMax = selectedStrategies.length >= 4;

      strategies.forEach(name => {
        const isOn = selectedStrategies.includes(name);
        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = "toggle";
        btn.textContent = name;
        btn.setAttribute("aria-pressed", isOn ? "true" : "false");

        if (!isOn && atMax) {
          btn.classList.add("disabled");
          btn.disabled = true;
        }

        btn.addEventListener("click", () => {
          const idx = selectedStrategies.indexOf(name);
          if (idx >= 0) {
            selectedStrategies.splice(idx, 1);
          } else {
            if (selectedStrategies.length >= 4) return;
            selectedStrategies.push(name);
          }
          renderStrategyButtons();
          updateCompletion();
          setSavedFlag(false);
        });

        grid.appendChild(btn);
      });

      $("strategyCount").textContent = `Selected: ${selectedStrategies.length} / 4`;
    }

    // ---------- Buttons ----------
    $("resetBtn").addEventListener("click", () => {
      if (!confirm("Reset all steps, selections, and clear the case text?")) return;

      $("caseText").value = "";
      ["step1","step2","step3","step4","step5"].forEach(id => $(id).value = "");
      $("timeTaken").value = "";
      $("confidence").value = "";
      $("clarity").value = "";

      selectedModality = "";
      selectedStrategies = [];
      renderModalityButtons();
      renderStrategyButtons();

      updateCompletion();
      setSavedFlag(false);
      setStatus("Reset complete.", "ok");
    });

    $("saveBtn").addEventListener("click", () => {
      localStorage.setItem(LS_KEY, JSON.stringify(getState()));
      setSavedFlag(true);
      setStatus("Saved locally (in this browser).", "ok");
    });

    $("loadBtn").addEventListener("click", () => {
      const raw = localStorage.getItem(LS_KEY);
      if (!raw) { setStatus("No saved draft found.", "warn"); return; }
      try { setState(JSON.parse(raw)); }
      catch { setStatus("Could not load saved draft (corrupt data).", "warn"); }
    });

    $("exportBtn").addEventListener("click", async () => {
      const out = exportText();
      await navigator.clipboard.writeText(out);
      setStatus("Export copied to clipboard.", "ok");
    });

    $("loadExampleBtn").addEventListener("click", () => {
      $("disorder").value = "Social Anxiety Disorder";
      $("caseText").value =
`A 27-year-old accountant reports intense anxiety during staff meetings and presentations. She experiences racing heart, trembling, and shortness of breath. She fears she will say something “stupid” and be judged. She worries for days beforehand and avoids situations where she might be the centre of attention. She has begun turning down opportunities at work and has reduced social contact. Symptoms have been present for five months and are interfering with occupational functioning.`;

      ["step1","step2","step3","step4","step5"].forEach(id => $(id).value = "");
      selectedModality = "";
      selectedStrategies = [];
      renderModalityButtons();
      renderStrategyButtons();

      updateCompletion();
      setSavedFlag(false);
      setStatus("Example case loaded. Start with Step 1.", "ok");
    });

    // ---------- AI generation (optional) ----------
    $("generateBtn").addEventListener("click", async () => {
      const mode = $("mode").value;

      if (mode === "manual") {
        if (!($("caseText").value || "").trim()) {
          setStatus("Paste a case vignette first (or click “Load example case”).", "warn");
        } else {
          setStatus("Great — start Step 1: summarise the presenting issue.", "ok");
        }
        return;
      }

      // AI mode
      const disorder = $("disorder").value || "Generalised Anxiety Disorder";
      $("generateBtn").disabled = true;
      setStatus("Generating case via Netlify function…");

      try {
        const res = await fetch("/.netlify/functions/generate-case", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ disorder })
        });

        const text = await res.text();
        if (!res.ok) {
          setStatus(`Request failed (${res.status}).`, "warn");
          alert(text);
          return;
        }

        let data;
        try { data = JSON.parse(text); }
        catch {
          setStatus("Function returned non-JSON. Check your function output.", "warn");
          alert(text);
          return;
        }

        const title = data.title || `Case: ${disorder}`;
        const vignette = data.vignette || "";

        $("caseText").value = `${title}\n\n${vignette}`.trim();

        // fresh run: clear steps + selections
        ["step1","step2","step3","step4","step5"].forEach(id => $(id).value = "");
        selectedModality = "";
        selectedStrategies = [];
        renderModalityButtons();
        renderStrategyButtons();

        updateCompletion();
        setSavedFlag(false);
        setStatus("Case generated. Start Step 1.", "ok");
      } catch (e) {
        setStatus("Failed to reach the function. Make sure you’re on the Netlify site URL.", "warn");
        alert(e?.message || String(e));
      } finally {
        $("generateBtn").disabled = false;
      }
    });

    // ---------- Live completion tracking ----------
    ["step1","step2","step3","step4","step5"].forEach(id => {
      $(id).addEventListener("input", () => {
        updateCompletion();
        setSavedFlag(false);
      });
    });
    ["timeTaken","confidence","clarity","caseText","disorder","mode"].forEach(id => {
      $(id).addEventListener("input", () => setSavedFlag(false));
      $(id).addEventListener("change", () => setSavedFlag(false));
    });

    // Init
    renderModalityButtons();
    renderStrategyButtons();
    updateCompletion();
    setSavedFlag(false);
  </script>
</body>
</html>
