<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Case-Based Reasoning (NPE)</title>
  <style>
    :root { color-scheme: light; }
    body {
  font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
      background:#f6f6f6; color:#111; margin:0; padding:24px 14px;
    }
    .wrap{ max-width: 980px; margin:0 auto; }
    header{ margin-bottom: 14px; }
    h1{ margin:0 0 6px; font-size: 28px; letter-spacing:-0.02em; }
    .sub{ margin:0; color:#444; line-height:1.45; }

    .card{
      background:#fff; border:1px solid rgba(0,0,0,.06);
      border-radius:14px; padding:16px; box-shadow:0 1px 10px rgba(0,0,0,.05);
      margin-top:12px;
    }

    .row{ display:grid; grid-template-columns: 1fr; gap:12px; }
    @media (min-width: 920px){
      .row.cols2{ grid-template-columns: 1fr 1fr; }
      .row.cols3{ grid-template-columns: 1fr 1fr 1fr; }
    }

    label{ display:block; font-size:13px; color:#333; margin-bottom:6px; font-weight:650; }
    textarea, input, select{
      width:100%; box-sizing:border-box;
      padding:11px 12px; border-radius:10px; border:1px solid rgba(0,0,0,.18);
      font-size:15px; outline:none; background:#fff;
      font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
    }
    textarea{ min-height: 140px; resize: vertical; line-height:1.45; }
    textarea:focus, input:focus, select:focus{ border-color: rgba(0,0,0,.45); }

    .btnrow{ display:flex; gap:10px; flex-wrap:wrap; margin-top:10px; }
    button{
      padding:11px 13px; border-radius:10px; border:1px solid #000;
      background:#000; color:#fff; cursor:pointer; font-size:15px;
    }
    button.secondary{ background:#fff; color:#000; border-color: rgba(0,0,0,.25); }
    button:disabled{ opacity:.6; cursor:not-allowed; }

    .stepHeader{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      margin-bottom: 8px;
    }
    .stepTitle{ font-size:15px; font-weight:800; margin:0; }
    .pill{
      font-size:12px; color:#444; background: rgba(0,0,0,.05);
      padding:6px 10px; border-radius: 999px;
    }
.chips{
  display:flex; flex-wrap:wrap; gap:8px;
  padding:10px; border:1px solid rgba(0,0,0,.12);
  border-radius:12px; background: rgba(0,0,0,.02);
  min-height: 44px;
}
.chip{
  display:inline-flex; align-items:center; gap:8px;
  padding:8px 10px; border-radius:999px;
  border:1px solid rgba(0,0,0,.18);
  background:#fff; font-size:13px;
}
.chip button{
  border:none; background:transparent; color:#000;
  cursor:pointer; font-size:16px; line-height:1;
  padding:0; margin:0;
}
.chip button:focus{ outline:2px solid rgba(0,0,0,.35); outline-offset:2px; }

    .hint{ color:#555; font-size:13px; line-height:1.45; margin:8px 0 0; }
    .small{ font-size:12px; color:#666; margin-top:8px; }
    .ok{ color:#0a7a2f; }
    .warn{ color:#b00020; }

    .toggleGrid{
      display:flex; flex-wrap:wrap; gap:10px; margin-top:10px;
    }
    .toggle{
      border:1px solid rgba(0,0,0,.18);
      background:#fff; color:#111;
      border-radius:999px; padding:10px 12px;
      font-size:14px; cursor:pointer;
      user-select:none;
      transition: transform .04s ease;
    }
    .toggle:active{ transform: scale(0.98); }
    .toggle[aria-pressed="true"]{
      background:#000; color:#fff; border-color:#000;
    }
    .toggle.disabled{ opacity:.45; cursor:not-allowed; }
    .toggle:disabled{ opacity:.45; cursor:not-allowed; }

    .meta{
      display:flex; gap:10px; flex-wrap:wrap; align-items:center;
      margin-top:10px; color:#444; font-size:13px;
    }
    .badge{
      background: rgba(0,0,0,.05);
      border:1px solid rgba(0,0,0,.08);
      border-radius:999px;
      padding:6px 10px;
    }

    footer{ margin-top:16px; color:#777; font-size:12px; line-height:1.4; }
    code{ font-family: "Helvetica Neue", Helvetica, Arial, sans-serif; }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Case-Based Reasoning</h1>
      <p class="sub">
        Select a DSM-5 disorder → generate a fictional vignette → work through steps 1–7.
      </p>
    </header>

    <!-- AI CASE GENERATION ONLY -->
    <div class="card">
      <div class="row cols2">
        <div>
<label for="clientAge">Client age group</label>
<select id="clientAge">
  <option value="">— Choose —</option>
  <option value="Child">Child</option>
  <option value="Adolescent">Adolescent</option>
  <option value="Adult">Adult</option>
  <option value="Older adult">Older adult</option>
</select>
        </div>

        <div>
          <label>&nbsp;</label>
          <button id="generateBtn" style="width:100%;">Generate case</button>
          <div class="small" id="status"></div>
        </div>
      </div>

      <div class="row" style="margin-top:10px;">
        <div>
          <label for="caseText">Generated case vignette</label>
          <textarea id="caseText" placeholder="Your generated vignette will appear here…" readonly></textarea>
          <p class="small">After generating, summarise the vignette in Step 1 (1–2 sentences, timeframe + impairment).</p>
        </div>
      </div>
<div class="btnrow">
</div>
    </div>

    <!-- STEP 1 -->
    <div class="card">
      <div class="stepHeader">
        <p class="stepTitle">Step 1 — Presenting issue</p>
        <span class="pill">1–2 sentences · timeframe + impairment</span>
      </div>
      <textarea id="step1" placeholder="Summarise the presenting issue in 1–2 sentences. Include timeframe + level of impairment."></textarea>
      <p class="hint">What is the main complaint? How long? What’s impaired (work/social/study/relationships)?</p>
    </div>

    <!-- STEP 2 -->
    <div class="card">
      <div class="stepHeader">
        <p class="stepTitle">Step 2 — Maintaining factors</p>
        <span class="pill">mechanisms, not labels</span>
      </div>
      <textarea id="step2" placeholder="What is maintaining the problem? (e.g., avoidance, reinforcement, rumination, negative thoughts, safety behaviours, sleep disruption, etc.)"></textarea>
    </div>
    
<!-- STEP 3 -->
<div class="card">
  <div class="stepHeader">
    <p class="stepTitle">Step 3 — Provisional diagnosis</p>
    <span class="pill">choose ONE · best fit</span>
  </div>

  <label for="dxSelect">Select one diagnosis</label>
  <select id="dxSelect">
    <option value="">— Choose —</option>

    <optgroup label="Neurodevelopmental disorders">
      <option>Attention-Deficit/Hyperactivity Disorder</option>
      <option>Autism Spectrum Disorder</option>
    </optgroup>

    <optgroup label="Psychotic disorders">
      <option>Schizophrenia</option>
    </optgroup>

    <optgroup label="Bipolar & depressive disorders">
      <option>Bipolar I Disorder</option>
      <option>Bipolar II Disorder</option>
      <option>Major Depressive Disorder</option>
      <option>Persistent Depressive Disorder</option>
    </optgroup>

    <optgroup label="Anxiety & related disorders">
      <option>Generalised Anxiety Disorder</option>
      <option>Panic Disorder</option>
      <option>Social Anxiety Disorder</option>
      <option>Separation Anxiety Disorder</option>
      <option>Obsessive-Compulsive Disorder</option>
    </optgroup>

    <optgroup label="Trauma & stressor-related disorders">
      <option>Post-Traumatic Stress Disorder</option>
      <option>Adjustment Disorder</option>
    </optgroup>

    <optgroup label="Somatic symptom & related disorders">
      <option>Somatic Symptom Disorder</option>
    </optgroup>

    <optgroup label="Eating disorders">
      <option>Anorexia Nervosa</option>
      <option>Bulimia Nervosa</option>
      <option>Binge-Eating Disorder</option>
    </optgroup>

    <optgroup label="Disruptive & impulse-control disorders">
      <option>Oppositional Defiant Disorder</option>
      <option>Conduct Disorder</option>
    </optgroup>

    <optgroup label="Substance-related disorders">
      <option>Substance Use Disorder</option>
    </optgroup>

    <optgroup label="Personality disorders">
      <option>Borderline Personality Disorder</option>
      <option>Antisocial Personality Disorder</option>
    </optgroup>

    <optgroup label="Neurocognitive disorders">
      <option>Delirium</option>
      <option>Mild Neurocognitive Disorder</option>
      <option>Major Neurocognitive Disorder</option>
    </optgroup>
  </select>

  <div class="meta">
    <span class="badge" id="dxChosen">Chosen: —</span>
  </div>
</div>



    <!-- STEP 4 -->
<div class="card">
  <div class="stepHeader">
    <p class="stepTitle">Step 4 — Differential diagnoses</p>
    <span class="pill">choose up to 4</span>
  </div>

  <div class="row cols2">
    <div>
      <label for="diffSelect">Add a differential</label>
      <select id="diffSelect">
        <option value="">— Choose —</option>

        <optgroup label="Neurodevelopmental disorders">
          <option>Attention-Deficit/Hyperactivity Disorder</option>
          <option>Autism Spectrum Disorder</option>
        </optgroup>

        <optgroup label="Psychotic disorders">
          <option>Schizophrenia</option>
        </optgroup>

        <optgroup label="Bipolar & depressive disorders">
          <option>Bipolar I Disorder</option>
          <option>Bipolar II Disorder</option>
          <option>Major Depressive Disorder</option>
          <option>Persistent Depressive Disorder</option>
        </optgroup>

        <optgroup label="Anxiety & related disorders">
          <option>Generalised Anxiety Disorder</option>
          <option>Panic Disorder</option>
          <option>Social Anxiety Disorder</option>
          <option>Separation Anxiety Disorder</option>
          <option>Obsessive-Compulsive Disorder</option>
        </optgroup>

        <optgroup label="Trauma & stressor-related disorders">
          <option>Post-Traumatic Stress Disorder</option>
          <option>Adjustment Disorder</option>
        </optgroup>

        <optgroup label="Somatic symptom & related disorders">
          <option>Somatic Symptom Disorder</option>
        </optgroup>

        <optgroup label="Eating disorders">
          <option>Anorexia Nervosa</option>
          <option>Bulimia Nervosa</option>
          <option>Binge-Eating Disorder</option>
        </optgroup>

        <optgroup label="Disruptive & impulse-control disorders">
          <option>Oppositional Defiant Disorder</option>
          <option>Conduct Disorder</option>
        </optgroup>

        <optgroup label="Substance-related disorders">
          <option>Substance Use Disorder</option>
        </optgroup>

        <optgroup label="Personality disorders">
          <option>Borderline Personality Disorder</option>
          <option>Antisocial Personality Disorder</option>
        </optgroup>

        <optgroup label="Neurocognitive disorders">
          <option>Delirium</option>
          <option>Mild Neurocognitive Disorder</option>
          <option>Major Neurocognitive Disorder</option>
        </optgroup>
      </select>

      <div class="btnrow" style="margin-top:10px;">
        <button type="button" class="secondary" id="addDiffBtn">Add differential</button>
        <button type="button" class="secondary" id="clearDiffBtn">Clear</button>
      </div>

      <div class="meta">
        <span class="badge" id="diffCount">Selected: 0 / 4</span>
        <span class="small">Suggestion: choose 1–4 only.</span>
      </div>
    </div>

    <div>
      <label>Selected differentials</label>
      <div id="diffChips" class="chips" aria-live="polite"></div>

      <label for="diffRationale" style="margin-top:12px;">Brief rule-out rationale (optional)</label>
      <textarea id="diffRationale" placeholder="Optional: 1–2 lines each explaining why each differential is less likely."></textarea>
    </div>
  </div>
</div>


    <!-- STEP 5 -->
<div class="card">
  <div class="stepHeader">
    <p class="stepTitle">Step 5 — Assessments</p>
    <span class="pill">choose multiple</span>
  </div>

  <p class="small"><strong>Intelligence and Educational</strong></p>
  <div class="toggleGrid assessmentGrid"></div>

  <p class="small"><strong>Memory</strong></p>
  <div class="toggleGrid assessmentGrid"></div>

  <p class="small"><strong>Vocational Scales</strong></p>
  <div class="toggleGrid assessmentGrid"></div>

  <p class="small"><strong>Personality</strong></p>
  <div class="toggleGrid assessmentGrid"></div>

  <p class="small"><strong>Functioning and Quality of Life</strong></p>
  <div class="toggleGrid assessmentGrid"></div>

  <p class="small"><strong>Clinical</strong></p>
  <div class="toggleGrid assessmentGrid"></div>

  <p class="small"><strong>Child and Adolescent</strong></p>
  <div class="toggleGrid assessmentGrid"></div>

  <div class="meta">
    <span class="badge" id="assessmentCount">Selected: 0</span>
  </div>
</div>


    <!-- STEP 6 -->
    <div class="card">
      <div class="stepHeader">
        <p class="stepTitle">Step 6 — Primary modality</p>
        <span class="pill">choose ONE</span>
      </div>
      <div class="toggleGrid" id="modalityGrid"></div>
      <div class="meta">
        <span class="badge" id="modalityChosen">Chosen: —</span>
      </div>
    </div>

    <!-- STEP 7 -->
    <div class="card">
      <div class="stepHeader">
        <p class="stepTitle">Step 7 — Intervention strategies</p>
        <span class="pill">choose 1–4</span>
      </div>
      <div class="toggleGrid" id="strategyGrid"></div>
      <div class="meta">
        <span class="badge" id="strategyCount">Selected: 0 / 4</span>
        <span class="small">Suggestion: choose 1–4 only.</span>
      </div>
    </div>
<!-- FINAL EXPORT -->
<div class="card" style="text-align:center;">
  <p class="stepTitle" style="margin-bottom:6px;">Finish & Export</p>
  <p class="small" style="margin-bottom:14px;">
    When you’re done, export your full case formulation.
  </p>

  <button id="submitBtn" style="
    padding:14px 22px;
    font-size:16px;
    border-radius:14px;
  ">
    Submit
  </button>
  <p class="small" id="submitStatus" style="margin-top:10px;"></p>
</div>
    <footer>
      Educational use only. Not clinical advice.
    </footer>
  </div>

  <script>
    const LS_KEY = "npe_case_reasoning_ai_only_v1";

    const modalities = [
      "Cognitive Behavioural Therapy",
      "Interpersonal Therapy",
      "Family Therapy",
      "Psychodynamic Therapy",
      "Narrative Therapy",
      "Solution-Focused Therapy",
      "Motivational Interviewing"
    ];

    const strategies = [
      "Psychoeducation",
      "Interpersonal therapy techniques",
      "Psychodynamic therapy techniques",
      "Solution-focused techniques",
      "Narrative therapy techniques",
      "Behaviour modification",
      "Gradual exposure",
      "Exposure response prevention",
      "Interoceptive exposure",
      "Prolonged exposure",
      "Cognitive restructuring",
      "Acceptance strategies",
      "Self-management",
      "Relapse prevention",
      "Progressive muscle relaxation",
      "Breathing retraining",
      "Problem solving skills training",
      "Anger management",
      "Social skills training",
      "Assertiveness skills training",
      "Stress management",
      "Mindfulness skills",
      "Parenting skills"
    ];

    const $ = (id) => document.getElementById(id);

    function setStatus(msg, kind="") {
      const el = $("status");
      el.textContent = msg || "";
      el.className = "small " + (kind || "");
    }

    // Step 6 (single selection)
    let selectedModality = "";

    function renderModalityButtons() {
      const grid = $("modalityGrid");
      grid.innerHTML = "";

      modalities.forEach(name => {
        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = "toggle";
        btn.textContent = name;
        btn.setAttribute("aria-pressed", selectedModality === name ? "true" : "false");

        btn.addEventListener("click", () => {
          selectedModality = (selectedModality === name) ? "" : name; // allow deselect
          renderModalityButtons();
        });

        grid.appendChild(btn);
      });

      $("modalityChosen").textContent = "Chosen: " + (selectedModality || "—");
    }

    // Step 7 (multi selection, max 4)
    let selectedStrategies = [];

    function renderStrategyButtons() {
      const grid = $("strategyGrid");
      grid.innerHTML = "";

      const atMax = selectedStrategies.length >= 4;

      strategies.forEach(name => {
        const isOn = selectedStrategies.includes(name);

        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = "toggle";
        btn.textContent = name;
        btn.setAttribute("aria-pressed", isOn ? "true" : "false");

        if (!isOn && atMax) btn.disabled = true;

        btn.addEventListener("click", () => {
          const idx = selectedStrategies.indexOf(name);
          if (idx >= 0) selectedStrategies.splice(idx, 1);
          else {
            if (selectedStrategies.length >= 4) return;
            selectedStrategies.push(name);
          }
          renderStrategyButtons();
        });

        grid.appendChild(btn);
      });

      $("strategyCount").textContent = `Selected: ${selectedStrategies.length} / 4`;
    }

    // AI generation
    $("generateBtn").addEventListener("click", async () => {
      const clientAge = $("clientAge").value;
      if (!clientAge) {
        setStatus("Choose a Client's Age Group first.", "warn");
        return;
      }

      $("generateBtn").disabled = true;
      setStatus("Generating case…");

      try {
        const res = await fetch("/.netlify/functions/generate-case", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
  clientAge: document.getElementById("clientAge")?.value || ""
})
        });

        const raw = await res.text();

        if (!res.ok) {
          setStatus(`Request failed (${res.status}).`, "warn");
          alert(raw);
          return;
        }

        let data;
        try { data = JSON.parse(raw); }
        catch {
          setStatus("Function returned non-JSON. Check your function output.", "warn");
          alert(raw);
          return;
        }

        const title = data.title || `Case: ${clientAge}`;
        const vignette = data.vignette || "";
        $("caseText").value = `${title}\n\n${vignette}`.trim();

        // Optional: clear steps each time you generate a new case
        $("step1").value = "";
$("step2").value = "";
$("dxSelect").value = "";
updateDxChosen();

selectedDifferentials = [];
$("diffSelect").value = "";
$("diffRationale").value = "";
renderDifferentials();

selectedAssessments = [];
renderAssessmentButtons();

selectedModality = "";
selectedStrategies = [];
renderModalityButtons();
renderStrategyButtons();


        setStatus("Case generated.", "ok");
      } catch (e) {
        setStatus("Failed to reach the function.", "warn");
        alert(e?.message || String(e));
      } finally {
        $("generateBtn").disabled = false;
      }
    });

    // Export


    $("exportBtn").addEventListener("click", async () => {
      const out =
`Client Age Group: ${$("clientAge").value || "(not set)"}

CASE VIGNETTE
${$("caseText").value || "(empty)"}

STEP 1 — PRESENTING ISSUE
${$("step1").value}

STEP 2 — MAINTAINING FACTORS
${$("step2").value}

STEP 3 — PROVISIONAL DIAGNOSIS
${selectedDiagnosis || "(none selected)"}

STEP 4 — DIFFERENTIAL DIAGNOSES (up to 4)
${selectedDifferentials.length ? selectedDifferentials.map(d => "- " + d).join("\n") : "(none selected)"}

Rule-out rationale (optional):
${$("diffRationale").value || "(blank)"}

STEP 5 — ASSESSMENTS
${selectedAssessments.length ? selectedAssessments.map(a => "- " + a).join("\n") : "(none selected)"}


STEP 6 — PRIMARY MODALITY
${selectedModality || "(none selected)"}

STEP 7 — STRATEGIES (1–4)
${selectedStrategies.length ? selectedStrategies.map(s => "- " + s).join("\n") : "(none selected)"}
`;
      
      await navigator.clipboard.writeText(out);
      setStatus("Export copied to clipboard.", "ok");
    });

// ===== STEP 3 — DIAGNOSIS (dropdown, single-select) =====
let selectedDiagnosis = "";

function updateDxChosen() {
  selectedDiagnosis = $("dxSelect")?.value || "";
  $("dxChosen").textContent = "Chosen: " + (selectedDiagnosis || "—");
}

$("dxSelect").addEventListener("change", updateDxChosen);
updateDxChosen(); // initialise

    // ===== STEP 4 — DIFFERENTIALS (dropdown + add chips, max 4) =====
let selectedDifferentials = [];

function renderDifferentials() {
  const wrap = $("diffChips");
  wrap.innerHTML = "";

  selectedDifferentials.forEach((name) => {
    const chip = document.createElement("div");
    chip.className = "chip";
    chip.innerHTML = `
      <span>${name}</span>
      <button type="button" aria-label="Remove ${name}">×</button>
    `;

    chip.querySelector("button").addEventListener("click", () => {
      selectedDifferentials = selectedDifferentials.filter((d) => d !== name);
      renderDifferentials();
    });

    wrap.appendChild(chip);
  });

  $("diffCount").textContent = `Selected: ${selectedDifferentials.length} / 4`;

  // lock add button when at max
  $("addDiffBtn").disabled = selectedDifferentials.length >= 4;
}

$("addDiffBtn").addEventListener("click", () => {
  const choice = $("diffSelect").value;
  if (!choice) return;

  if (selectedDifferentials.includes(choice)) {
    alert("That differential is already selected.");
    return;
  }

  if (selectedDifferentials.length >= 4) {
    alert("You can select up to 4 differentials.");
    return;
  }

  selectedDifferentials.push(choice);
  $("diffSelect").value = "";
  renderDifferentials();
});

$("clearDiffBtn").addEventListener("click", () => {
  selectedDifferentials = [];
  renderDifferentials();
});

renderDifferentials(); // init


    // ===== STEP 5 — ASSESSMENTS (multi-select) =====

const assessmentGroups = [
  {
    name: "Intelligence and Educational",
    items: [
      "WAIS (Wechsler Adult Intelligence Scale)",
      "WISC (Wechsler Intelligence Scale for Children)",
      "WPPSI (Wechsler Preschool and Primary Scale of Intelligence)",
      "Stanford-Binet (Stanford-Binet Intelligence Scales)",
      "WASI (Wechsler Abbreviated Scale of Intelligence)",
      "Woodcock-Johnson Test of Cognitive Abilities",
      "Raven's Standard Progressive Matrices",
      "WIAT (Wechsler Individual Achievement Test)"
    ]
  },
  {
    name: "Memory",
    items: [
      "WMS (Wechsler Memory Scale)",
      "WRAML (Wide Range Assessment of Memory and Learning)"
    ]
  },
  {
    name: "Vocational Scales",
    items: [
      "SDS (Self Directed Search)",
      "Strong (Strong Interest Inventory)"
    ]
  },
  {
    name: "Personality",
    items: [
      "16PF (Sixteen Personality Factor Questionnaire)",
      "NEO (NEO Personality Inventory)"
    ]
  },
  {
    name: "Functioning and Quality of Life",
    items: [
      "WHO-DAS (World Health Organisation Disability Assessment Scale)",
      "WHO-QOL (World Health Organisation Quality of Life Scale)",
      "ABAS (Adaptive Behavior Assessment System)",
      "ORS (Outcome Rating Scale)"
    ]
  },
  {
    name: "Clinical",
    items: [
      "BDI (Beck Depression Inventory)",
      "DASS (Depression Anxiety Stress Scale)",
      "K10 (Kessler Psychological Distress Scale)",
      "STAI (State Trait Anxiety Inventory)",
      "MMPI (Minnesota Multiphasic Personality Inventory)",
      "PAI (Personality Assessment Inventory)",
      "PHQ-9 (Patient Health Questionnaire 9 Item)",
      "Structured Clinical Interview for DSM (SCID)"
    ]
  },
  {
    name: "Child and Adolescent",
    items: [
      "CBCL (Achenbach Child Behaviour Checklist)",
      "SDQ (Strengths and Difficulties Questionnaire)"
    ]
  }
];

function renderAssessmentButtons() {
  const grids = document.querySelectorAll(".assessmentGrid");
  grids.forEach((grid, i) => {
    grid.innerHTML = "";
    assessmentGroups[i].items.forEach(name => {
      const isOn = selectedAssessments.includes(name);

      const btn = document.createElement("button");
      btn.type = "button";
      btn.className = "toggle";
      btn.textContent = name;
      btn.setAttribute("aria-pressed", isOn ? "true" : "false");

      btn.addEventListener("click", () => {
        const idx = selectedAssessments.indexOf(name);
        if (idx >= 0) selectedAssessments.splice(idx, 1);
        else selectedAssessments.push(name);
        renderAssessmentButtons();
      });

      grid.appendChild(btn);
    });
  });

  $("assessmentCount").textContent = `Selected: ${selectedAssessments.length}`;
}


// Init
renderModalityButtons();
renderStrategyButtons();
    selectedAssessments = [];
renderAssessmentButtons();

    const SUBMIT_KEY = "npe_case_submit_v1";

function buildSubmission() {
  return {
    createdAt: new Date().toISOString(),
    clientAge: $("clientAge").value || "",
    caseText: $("caseText").value || "",
    step1: $("step1").value || "",
    step2: $("step2").value || "",
    selectedDiagnosis: selectedDiagnosis || "",
    selectedDifferentials: selectedDifferentials || [],
    diffRationale: $("diffRationale").value || "",
    selectedAssessments: selectedAssessments || [],
    selectedModality: selectedModality || "",
    selectedStrategies: selectedStrategies || []
  };
}

$("submitBtn").addEventListener("click", () => {
  const sub = buildSubmission();

  if (!sub.clientAge || !sub.caseText.trim()) {
    $("submitStatus").textContent = "Generate a case first, then submit.";
    $("submitStatus").className = "small warn";
    return;
  }

  localStorage.setItem(SUBMIT_KEY, JSON.stringify(sub));
  window.location.href = "results.html";
});
  </script>
</body>
</html>
